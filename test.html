<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .panel {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: #075e54;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }
         .panel h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #06544c;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #075e54;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        
        button:hover {
            background-color: #054d44;
        }
         button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* Align with panel border */
            transition: border-color 0.2s ease, color 0.2s ease;
        }
        
        .tab.active {
            border-bottom-color: #075e54;
            color: #075e54;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            display: none; /* Hidden by default */
        }
        
        .progress-bar {
            height: 100%;
            background-color: #075e54;
            width: 0%;
            transition: width 0.3s ease-in-out;
            text-align: center;
            color: white;
            font-size: 0.8em;
            line-height: 20px;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none; /* Hidden by default, shown by JS */
        }
        
        .status.success {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
            display: block;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
            display: block;
        }
        
        /* Chat interface styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px; /* Or adjust as needed */
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #e5ded8; /* WhatsApp-like background */
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        .user-message {
            background-color: #dcf8c6; /* Light green for user */
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            background-color: #ffffff; /* White for bot */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #f0f0f0; /* Lighter grey for input area */
            border-top: 1px solid #ddd;
             border-radius: 0 0 8px 8px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px; /* More rounded input */
            margin-right: 10px;
            font-size: 1em;
        }
        
        .chat-input button {
            width: 45px; /* Slightly larger button */
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: #075e54;
        }
         .chat-input button:hover {
            background-color: #054d44;
        }
        .chat-input button svg {
            stroke: white;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            max-width: 80px;
            background-color: #ffffff;
            padding: 10px 15px;
            border-radius: 18px;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            margin-top: 5px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            display: none; /* Hidden by default */
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #8b9095; /* Grey dots */
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.3s ease-in-out infinite;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes typing {
            0%, 100% { transform: translateY(0px); background-color: #8b9095; }
            50% { transform: translateY(-5px); background-color: #5e6367; }
        }
        
        /* File input styling */
        .file-input-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-container .file-input-button {
            display: block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            color: #495057;
        }
        .file-input-container .file-input-button:hover {
            background-color: #e9ecef;
        }
        
        .file-input-container .file-name {
            margin-top: 8px;
            font-size: 0.9em;
            color: #6c757d;
            text-align: center;
        }
        
        .hidden { display: none; }
        
        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        table td button {
            padding: 5px 10px;
            font-size: 0.9em;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
            color: #075e54;
            font-weight: bold;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 10px;
            position: absolute;
            z-index: 1;
            bottom: 130%; /* Position above the tooltip icon */
            left: 50%;
            margin-left: -140px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            line-height: 1.4;
        }
        .tooltip .tooltip-text::after { /* Arrow */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Responsive design */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <div class="panel">
                <h2>API Configuration</h2>
                <div class="form-group">
                    <label for="api-url">API URL</label>
                    <input type="text" id="api-url" placeholder="http://localhost or server IP" value="http://127.0.0.1">
                </div>
                <div class="form-group">
                    <label for="api-port">Port</label>
                    <input type="text" id="api-port" placeholder="8000" value="8000">
                </div>
                <div class="form-group">
                    <label for="api-key">API Key 
                        <span class="tooltip">?
                            <span class="tooltip-text">Enter the API Key (starts with sk-...) provided for your tenant. This key is used to authenticate requests to the chatbot and management APIs.</span>
                        </span>
                    </label>
                    <input type="text" id="api-key" placeholder="sk-...">
                </div>
                <button id="save-config">Save and Load Tenant</button>
                <div id="config-status" class="status"></div>
            </div>
            
            <div class="panel">
                <h2>Tenant Information</h2>
                <div id="current-tenant-info">
                    <p>Enter and save your API Key above to load tenant details.</p>
                </div>
            </div>
            
            <div class="panel">
                <h2>Knowledge Management</h2>
                <div class="tabs">
                    <div class="tab active" data-tab="kb">Knowledge Base</div>
                    <div class="tab" data-tab="faq">FAQ</div>
                    <div class="tab" data-tab="prompt">System Prompt</div>
                </div>
                
                <div class="tab-content active" id="kb-tab">
                    <h3>Upload New Knowledge Document</h3>
                    <div class="form-group">
                        <label for="kb-name">Document Name</label>
                        <input type="text" id="kb-name" placeholder="E.g., Product Manual Q1">
                    </div>
                    <div class="file-input-container">
                        <div class="file-input-button">
                            Click to select a file (.pdf, .docx, .txt)
                        </div>
                        <div class="file-name" id="kb-file-name">No file selected</div>
                        <input type="file" id="kb-file" accept=".pdf,.docx,.doc,.txt">
                    </div>
                    <button id="upload-kb">Upload Knowledge Base</button>
                    <div class="progress" id="kb-progress">
                        <div class="progress-bar" id="kb-progress-bar">0%</div>
                    </div>
                    <div id="kb-status" class="status"></div>
                    
                    <h3>Existing Knowledge Bases</h3>
                    <table id="kb-list">
                        <thead><tr><th>Name</th><th>Type</th><th>Actions</th></tr></thead>
                        <tbody><tr><td colspan="3">Load tenant to see knowledge bases.</td></tr></tbody>
                    </table>
                </div>
                
                <div class="tab-content" id="faq-tab">
                    <h3>Add Single FAQ</h3>
                    <div class="form-group">
                        <label for="faq-question">Question</label>
                        <input type="text" id="faq-question" placeholder="Enter a frequently asked question">
                    </div>
                    <div class="form-group">
                        <label for="faq-answer">Answer</label>
                        <textarea id="faq-answer" placeholder="Enter the answer to the question"></textarea>
                    </div>
                    <button id="add-faq">Add FAQ</button>
                    <div id="faq-single-status" class="status"></div>
                    
                    <h3 style="margin-top: 30px;">Upload FAQ Sheet</h3>
                    <div class="form-group">
                        <label>Upload a CSV or Excel file with 'question' and 'answer' columns.</label>
                    </div>
                    <div class="file-input-container">
                        <div class="file-input-button">Click to select a file (.csv, .xlsx)</div>
                        <div class="file-name" id="faq-file-name">No file selected</div>
                        <input type="file" id="faq-file" accept=".csv,.xlsx,.xls">
                    </div>
                    <button id="upload-faq">Upload FAQ Sheet</button>
                    <div class="progress" id="faq-progress">
                        <div class="progress-bar" id="faq-progress-bar">0%</div>
                    </div>
                    <div id="faq-status" class="status"></div>
                    
                    <h3>Existing FAQs</h3>
                    <table id="faq-list">
                        <thead><tr><th>Question</th><th>Answer</th><th>Actions</th></tr></thead>
                        <tbody><tr><td colspan="3">Load tenant to see FAQs.</td></tr></tbody>
                    </table>
                </div>
                
                <div class="tab-content" id="prompt-tab">
                    <h3>Customize System Prompt</h3>
                    <div class="form-group">
                        <label for="system-prompt">System Prompt 
                            <span class="tooltip">?
                                <span class="tooltip-text">This is the core instruction for your chatbot. It defines its persona, capabilities, and how it should use the knowledge base and FAQs. Use the variables below to dynamically insert tenant-specific information.</span>
                            </span>
                        </label>
                        <textarea id="system-prompt" placeholder="Enter your custom system prompt. Use variables like {company_name}, {knowledge_base_info}, {faq_info}, and {context} for retrieved documents." rows="12"></textarea>
                    </div>
                    <div class="form-group">
                        <p style="font-weight:500; margin-bottom: 5px;">Available Variables:</p>
                        <ul style="font-size:0.9em; list-style-position: inside;">
                            <li><code>{company_name}</code> - Your tenant's name.</li>
                            <li><code>{knowledge_base_info}</code> - Placeholder for knowledge from a specific loaded document name (used by backend).</li>
                            <li><code>{faq_info}</code> - All FAQs formatted as a string (used by backend).</li>
                            <li><code>{context}</code> - Placeholder for context retrieved from documents during a query (used by backend).</li>
                        </ul>
                    </div>
                    <button id="save-prompt">Save System Prompt</button>
                    <div id="prompt-status" class="status"></div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>Chatbot Interface</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot-message">
                        Hello! I'm your AI assistant. Configure your API Key and load tenant details to begin.
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Type a message..." disabled>
                    <button id="send-button" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const apiUrlInput = document.getElementById('api-url');
        const apiPortInput = document.getElementById('api-port');
        const apiKeyInput = document.getElementById('api-key');
        const saveConfigButton = document.getElementById('save-config');
        const configStatus = document.getElementById('config-status');
        
        const currentTenantInfo = document.getElementById('current-tenant-info');
        
        const kbNameInput = document.getElementById('kb-name');
        const kbFileInput = document.getElementById('kb-file');
        const kbFileName = document.getElementById('kb-file-name');
        const uploadKbButton = document.getElementById('upload-kb');
        const kbProgress = document.getElementById('kb-progress');
        const kbProgressBar = document.getElementById('kb-progress-bar');
        const kbStatus = document.getElementById('kb-status');
        const kbListTableBody = document.getElementById('kb-list').querySelector('tbody');
        
        const faqQuestionInput = document.getElementById('faq-question');
        const faqAnswerInput = document.getElementById('faq-answer');
        const addFaqButton = document.getElementById('add-faq');
        const faqSingleStatus = document.getElementById('faq-single-status');
        const faqFileInput = document.getElementById('faq-file');
        const faqFileName = document.getElementById('faq-file-name');
        const uploadFaqButton = document.getElementById('upload-faq');
        const faqProgress = document.getElementById('faq-progress');
        const faqProgressBar = document.getElementById('faq-progress-bar');
        const faqStatus = document.getElementById('faq-status');
        const faqListTableBody = document.getElementById('faq-list').querySelector('tbody');
        
        const systemPromptInput = document.getElementById('system-prompt');
        const savePromptButton = document.getElementById('save-prompt');
        const promptStatus = document.getElementById('prompt-status');
        
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Global state
        let apiUrl = localStorage.getItem('chatbot_api_url') || 'http://127.0.0.1';
        let apiPort = localStorage.getItem('chatbot_api_port') || '8000'; // Default to 8000
        let currentApiKey = localStorage.getItem('chatbot_api_key') || '';
        let currentTenantId = null;
        const userId = localStorage.getItem('chatbot_user_id') || 'user_' + Math.random().toString(36).substring(2, 9);
        localStorage.setItem('chatbot_user_id', userId);

        // Utility to get full API base URL
        function getApiBaseUrl() {
            return `${apiUrlInput.value.trim()}:${apiPortInput.value.trim()}`;
        }

        // Utility to show notification messages
        function showNotification(element, message, isSuccess = true) {
            element.textContent = message;
            element.className = isSuccess ? 'status success' : 'status error';
            setTimeout(() => {
                element.className = 'status hidden'; // Hide after timeout
            }, 5000);
        }
        
        // Utility to add messages to the chat interface
        function addChatMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message bot-message';
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        // Tabs management
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab.active').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content.active').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        // File input name display
        [kbFileInput, faqFileInput].forEach(input => {
            const nameDisplayId = input.id === 'kb-file' ? 'kb-file-name' : 'faq-file-name';
            const nameDisplay = document.getElementById(nameDisplayId);
            input.addEventListener('change', () => {
                nameDisplay.textContent = input.files.length > 0 ? input.files[0].name : 'No file selected';
            });
        });
        
        // Function to fetch and display tenant details
        async function fetchAndStoreTenantDetails() {
            if (!currentApiKey) {
                showNotification(configStatus, 'API Key is not set in the configuration.', false);
                currentTenantInfo.innerHTML = '<p>API Key is not set. Please enter and save configuration.</p>';
                systemPromptInput.value = '';
                currentTenantId = null;
                messageInput.disabled = true;
                sendButton.disabled = true;
                return false;
            }

            try {
                const response = await fetch(`${getApiBaseUrl()}/tenants/details/by-apikey`, {
                    method: 'GET',
                    headers: { 'X-API-Key': currentApiKey }
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to fetch tenant details. Check API Key and server.');
                }

                const tenant = await response.json();
                currentTenantId = tenant.id;
                currentTenantInfo.innerHTML = `
                    <p><strong>ID:</strong> ${tenant.id}</p>
                    <p><strong>Name:</strong> ${tenant.name}</p>
                    <p><strong>Description:</strong> ${tenant.description || 'N/A'}</p>
                    <p><strong>API Key:</strong> ${tenant.api_key}</p>
                    <p><strong>Active:</strong> ${tenant.is_active ? 'Yes' : 'No'}</p>
                `;
                systemPromptInput.value = tenant.system_prompt || '';
                showNotification(configStatus, `Tenant "${tenant.name}" loaded successfully!`, true);
                messageInput.disabled = false;
                sendButton.disabled = false;
                return true;
            } catch (error) {
                console.error("Error fetching tenant details:", error);
                currentTenantInfo.innerHTML = `<p style="color: red;">Could not load tenant details: ${error.message}.</p>`;
                systemPromptInput.value = '';
                currentTenantId = null;
                messageInput.disabled = true;
                sendButton.disabled = true;
                return false;
            }
        }

        // Handle saving API configuration
        saveConfigButton.addEventListener('click', async () => {
            apiUrl = apiUrlInput.value.trim();
            apiPort = apiPortInput.value.trim();
            currentApiKey = apiKeyInput.value.trim(); // Update global currentApiKey

            if (!currentApiKey) {
                showNotification(configStatus, 'API Key cannot be empty.', false);
                return;
            }

            localStorage.setItem('chatbot_api_url', apiUrl);
            localStorage.setItem('chatbot_api_port', apiPort);
            localStorage.setItem('chatbot_api_key', currentApiKey);
            
            const detailsFetched = await fetchAndStoreTenantDetails();
            if (detailsFetched) {
                refreshKnowledgeBases();
                refreshFaqs();
            } else {
                // Clear lists if tenant loading failed
                kbListTableBody.innerHTML = '<tr><td colspan="3">Failed to load tenant. Cannot fetch knowledge bases.</td></tr>';
                faqListTableBody.innerHTML = '<tr><td colspan="3">Failed to load tenant. Cannot fetch FAQs.</td></tr>';
            }
        });

        // Generic file upload function
        async function handleFileUpload(endpoint, fileInput, nameInput, statusElement, progressBarElement, progressContainerElement, successCallback) {
            const file = fileInput.files[0];
            const name = nameInput ? nameInput.value.trim() : null; // Name is optional for some uploads

            if (nameInput && !name && endpoint.includes('/knowledge-base/upload')) { // Name required for KB
                showNotification(statusElement, 'Please enter a document name.', false);
                return;
            }
            if (!file) {
                showNotification(statusElement, 'Please select a file.', false);
                return;
            }
            if (!currentApiKey) {
                showNotification(statusElement, 'API Key is not configured.', false);
                return;
            }
             if (!currentTenantId) {
                showNotification(statusElement, 'Tenant not loaded. Configure API key and load tenant first.', false);
                return;
            }


            progressContainerElement.style.display = 'block';
            progressBarElement.style.width = '0%';
            progressBarElement.textContent = '0%';

            const formData = new FormData();
            formData.append('file', file);
            if (name) formData.append('name', name); // Add name if provided (for KB)

            try {
                // Simulate progress (real progress requires XHR or server events)
                let progress = 0;
                const interval = setInterval(() => {
                    progress = Math.min(progress + 10, 90);
                    progressBarElement.style.width = `${progress}%`;
                    progressBarElement.textContent = `${progress}%`;
                }, 200);

                const response = await fetch(`${getApiBaseUrl()}${endpoint}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': currentApiKey },
                    body: formData
                });

                clearInterval(interval);
                progressBarElement.style.width = '100%';
                progressBarElement.textContent = '100%';

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || JSON.stringify(err));
                }
                const data = await response.json();
                showNotification(statusElement, `File uploaded successfully. ${data.message || ''}`, true);
                if (fileInput) fileInput.value = ''; // Clear file input
                if (nameInput) nameInput.value = ''; // Clear name input
                document.getElementById(fileInput.id === 'kb-file' ? 'kb-file-name' : 'faq-file-name').textContent = 'No file selected';
                
                if (successCallback) successCallback();

            } catch (error) {
                showNotification(statusElement, `Upload failed: ${error.message}`, false);
                 progressBarElement.style.width = '0%';
                 progressBarElement.textContent = '0%';
            } finally {
                setTimeout(() => { 
                    progressContainerElement.style.display = 'none';
                    progressBarElement.style.width = '0%';
                    progressBarElement.textContent = '0%';
                }, 2000);
            }
        }
        
        // Upload Knowledge Base
        uploadKbButton.addEventListener('click', () => {
            handleFileUpload('/knowledge-base/upload', kbFileInput, kbNameInput, kbStatus, kbProgressBar, kbProgress, refreshKnowledgeBases);
        });
        
        // Upload FAQ Sheet
        uploadFaqButton.addEventListener('click', () => {
            handleFileUpload('/knowledge-base/faqs/upload', faqFileInput, null, faqStatus, faqProgressBar, faqProgress, refreshFaqs);
        });

        // Refresh Knowledge Base List
        async function refreshKnowledgeBases() {
            if (!currentApiKey || !currentTenantId) {
                kbListTableBody.innerHTML = '<tr><td colspan="3">Configure API Key and load tenant to see knowledge bases.</td></tr>';
                return;
            }
            try {
                const response = await fetch(`${getApiBaseUrl()}/knowledge-base/`, {
                    headers: { 'X-API-Key': currentApiKey }
                });
                if (!response.ok) throw new Error((await response.json()).detail || 'Failed to fetch KBs');
                const kbs = await response.json();
                kbListTableBody.innerHTML = ''; // Clear existing
                if (kbs.length === 0) {
                    kbListTableBody.innerHTML = '<tr><td colspan="3">No knowledge bases found for this tenant.</td></tr>';
                } else {
                    kbs.forEach(kb => {
                        const row = kbListTableBody.insertRow();
                        row.innerHTML = `<td>${kb.name}</td><td>${kb.document_type || 'N/A'}</td><td><button class="delete-kb" data-id="${kb.id}">Delete</button></td>`;
                    });
                    document.querySelectorAll('.delete-kb').forEach(btn => btn.addEventListener('click', deleteKnowledgeBase));
                }
            } catch (error) {
                kbListTableBody.innerHTML = `<tr><td colspan="3" style="color:red;">Error: ${error.message}</td></tr>`;
            }
        }

        // Delete Knowledge Base
        async function deleteKnowledgeBase(event) {
            const kbId = event.target.dataset.id;
            if (!currentApiKey || !kbId || !confirm('Are you sure you want to delete this knowledge base item?')) return;
            try {
                const response = await fetch(`${getApiBaseUrl()}/knowledge-base/${kbId}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': currentApiKey }
                });
                if (!response.ok) throw new Error((await response.json()).detail || 'Failed to delete KB');
                showNotification(kbStatus, 'Knowledge base item deleted successfully.', true);
                refreshKnowledgeBases();
            } catch (error) {
                showNotification(kbStatus, `Error deleting KB: ${error.message}`, false);
            }
        }
        
        // Add Single FAQ
        addFaqButton.addEventListener('click', async () => {
            const question = faqQuestionInput.value.trim();
            const answer = faqAnswerInput.value.trim();
            if (!question || !answer) {
                showNotification(faqSingleStatus, 'Question and Answer cannot be empty.', false); return;
            }
            if (!currentApiKey || !currentTenantId) {
                showNotification(faqSingleStatus, 'API Key/Tenant not configured.', false); return;
            }
            try {
                const response = await fetch(`${getApiBaseUrl()}/knowledge-base/faqs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': currentApiKey },
                    body: JSON.stringify({ question, answer })
                });
                if (!response.ok) throw new Error((await response.json()).detail || 'Failed to add FAQ');
                showNotification(faqSingleStatus, 'FAQ added successfully!', true);
                faqQuestionInput.value = ''; faqAnswerInput.value = '';
                refreshFaqs();
            } catch (error) {
                showNotification(faqSingleStatus, `Error: ${error.message}`, false);
            }
        });

        // Refresh FAQ List
        async function refreshFaqs() {
            if (!currentApiKey || !currentTenantId) {
                faqListTableBody.innerHTML = '<tr><td colspan="3">Configure API Key and load tenant to see FAQs.</td></tr>';
                return;
            }
            try {
                const response = await fetch(`${getApiBaseUrl()}/knowledge-base/faqs`, {
                    headers: { 'X-API-Key': currentApiKey }
                });
                if (!response.ok) throw new Error((await response.json()).detail || 'Failed to fetch FAQs');
                const faqs = await response.json();
                faqListTableBody.innerHTML = ''; // Clear existing
                if (faqs.length === 0) {
                    faqListTableBody.innerHTML = '<tr><td colspan="3">No FAQs found for this tenant.</td></tr>';
                } else {
                    faqs.forEach(faq => {
                        const row = faqListTableBody.insertRow();
                        const shortAnswer = faq.answer.length > 50 ? faq.answer.substring(0, 47) + '...' : faq.answer;
                        row.innerHTML = `<td>${faq.question}</td><td>${shortAnswer}</td><td><button class="delete-faq" data-id="${faq.id}">Delete</button></td>`;
                    });
                    document.querySelectorAll('.delete-faq').forEach(btn => btn.addEventListener('click', deleteFaq));
                }
            } catch (error) {
                faqListTableBody.innerHTML = `<tr><td colspan="3" style="color:red;">Error: ${error.message}</td></tr>`;
            }
        }
        
        // Delete FAQ
        async function deleteFaq(event) {
            const faqId = event.target.dataset.id;
            if (!currentApiKey || !faqId || !confirm('Are you sure you want to delete this FAQ?')) return;
            try {
                const response = await fetch(`${getApiBaseUrl()}/knowledge-base/faqs/${faqId}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': currentApiKey }
                });
                if (!response.ok) throw new Error((await response.json()).detail || 'Failed to delete FAQ');
                showNotification(faqStatus, 'FAQ deleted successfully.', true); // Use main faqStatus for this
                refreshFaqs();
            } catch (error) {
                showNotification(faqStatus, `Error deleting FAQ: ${error.message}`, false);
            }
        }

        // Save System Prompt
        savePromptButton.addEventListener('click', async () => {
            const promptText = systemPromptInput.value.trim();
            if (!promptText) {
                showNotification(promptStatus, 'System prompt cannot be empty.', false); return;
            }
            if (!currentApiKey) {
                showNotification(promptStatus, 'API Key is not configured.', false); return;
            }
            if (!currentTenantId) {
                showNotification(promptStatus, 'Tenant not loaded. Configure API Key and load tenant first.', false); return;
            }

            try {
                const response = await fetch(`${getApiBaseUrl()}/tenants/${currentTenantId}/prompt`, { // CORRECTED URL
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': currentApiKey 
                    },
                    body: JSON.stringify({ system_prompt: promptText })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || JSON.stringify(errorData));
                }
                const updatedTenant = await response.json();
                showNotification(promptStatus, `System prompt for "${updatedTenant.name}" saved successfully!`, true);
            } catch (error) {
                showNotification(promptStatus, `Failed to save system prompt: ${error.message}`, false);
            }
        });
        
        // Send Chat Message
        async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user-message');
    input.value = '';
    
    // Show thinking indicator
    const thinkingMessage = addMessage('Thinking...', 'bot-message thinking');
    
    try {
        // Call the delayed endpoint - all timing handled on backend
        const response = await fetch('/chatbot/chat/delayed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': 'sk-2f5e6184cad141e081154464b4ce919f'
            },
            body: JSON.stringify({
                message: message,
                user_identifier: 'user123'
            })
        });
        
        const result = await response.json();
        
        // Remove thinking indicator
        thinkingMessage.remove();
        
        if (result.success) {
            // Add the complete response (delays already handled by backend)
            addMessage(result.response, 'bot-message');
            
            // Show timing info
            if (result.response_delay_info) {
                const info = result.response_delay_info;
                console.log(`Response timing: ${info.total_response_time.toFixed(1)}s total (${info.initial_thinking_time.toFixed(1)}s thinking + ${info.typing_simulation_time.toFixed(1)}s typing)`);
            }
        } else {
            addMessage('Sorry, there was an error.', 'bot-message');
        }
        
    } catch (error) {
        thinkingMessage.remove();
        addMessage('Connection error. Please try again.', 'bot-message');
    }
}

        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                addChatMessage(message, true);
                messageInput.value = '';
                sendChatMessage(message);
            }
        });
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
        // Initial page load setup
        document.addEventListener('DOMContentLoaded', async () => {
            apiUrlInput.value = apiUrl;
            apiPortInput.value = apiPort;
            apiKeyInput.value = currentApiKey;

            if (currentApiKey) {
                const detailsFetched = await fetchAndStoreTenantDetails();
                if (detailsFetched) {
                    refreshKnowledgeBases();
                    refreshFaqs();
                }
            } else {
                currentTenantInfo.innerHTML = '<p>No API Key configured. Please enter and save your API Key in the "API Configuration" section.</p>';
                messageInput.disabled = true;
                sendButton.disabled = true;
                kbListTableBody.innerHTML = '<tr><td colspan="3">Configure API Key and load tenant to see knowledge bases.</td></tr>';
                faqListTableBody.innerHTML = '<tr><td colspan="3">Configure API Key and load tenant to see FAQs.</td></tr>';
            }
        });
    </script>
</body>
</html>
