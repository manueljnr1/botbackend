<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .panel {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: #075e54;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #075e54;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            background-color: #054d44;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #075e54;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #075e54;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        /* Chat interface styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #e5ded8;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            position: relative;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #dcf8c6;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        
        .bot-message {
            background-color: white;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 5px 5px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 30px;
            margin-right: 10px;
        }
        
        .chat-input button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            max-width: 100px;
            background-color: white;
            padding: 10px 15px;
            border-radius: 10px;
            align-self: flex-start;
            border-bottom-left-radius: 0;
            margin-top: 5px;
            display: none;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #8b9095;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.3s ease-in-out infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.15s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.3s;
        }
        
        @keyframes typing {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
            100% {
                transform: translateY(0px);
            }
        }
        
        /* File upload styling */
        .file-input-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-container .file-input-button {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }
        
        .file-input-container .file-name {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        table th {
            background-color: #f0f0f0;
            font-weight: 500;
        }
        
        /* Token info tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left column with management tools -->
        <div>
            <!-- API Key Management -->
            <div class="panel">
                <h2>API Configuration</h2>
                <div class="form-group">
                    <label for="api-url">API URL</label>
                    <input type="text" id="api-url" placeholder="http://localhost or server IP" value="http://127.0.0.1">
                </div>
                <div class="form-group">
                    <label for="api-port">Port</label>
                    <input type="text" id="api-port" placeholder="8000" value="8001">
                </div>
                <div class="form-group">
                    <label for="api-key">API Key 
                        <span class="tooltip">?
                            <span class="tooltip-text">The tenant API key (starts with sk-...)</span>
                        </span>
                    </label>
                    <input type="text" id="api-key" placeholder="sk-...">
                </div>
                <button id="save-config">Save Configuration</button>
                <div id="config-status" class="status"></div>
            </div>
            
            <!-- Tenant management -->
            <div class="panel">
                <h2>Tenant Management</h2>
                <div class="form-group">
                    <label for="tenant-name">Tenant Name</label>
                    <input type="text" id="tenant-name" placeholder="Your Company Name">
                </div>
                <div class="form-group">
                    <label for="tenant-description">Description</label>
                    <input type="text" id="tenant-description" placeholder="Brief description">
                </div>
                <button id="create-tenant">Create Tenant</button>
                <div id="tenant-status" class="status"></div>
                
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Current Tenant</h3>
                <div id="current-tenant-info">
                    <p>No tenant selected. Use API key to access your tenant.</p>
                </div>
            </div>
            
            <!-- Knowledge Base & FAQ Management -->
            <div class="panel">
                <h2>Knowledge Management</h2>
                <div class="tabs">
                    <div class="tab active" data-tab="kb">Knowledge Base</div>
                    <div class="tab" data-tab="faq">FAQ</div>
                    <div class="tab" data-tab="prompt">System Prompt</div>
                </div>
                
                <!-- Knowledge Base Tab -->
                <div class="tab-content active" id="kb-tab">
                    <div class="form-group">
                        <label for="kb-name">Document Name</label>
                        <input type="text" id="kb-name" placeholder="Company Knowledge Base">
                    </div>
                    <div class="file-input-container">
                        <div class="file-input-button">
                            Click to select a file (.pdf, .docx, .txt)
                        </div>
                        <div class="file-name" id="kb-file-name">No file selected</div>
                        <input type="file" id="kb-file" accept=".pdf,.docx,.doc,.txt">
                    </div>
                    <button id="upload-kb">Upload Knowledge Base</button>
                    <div class="progress" id="kb-progress">
                        <div class="progress-bar" id="kb-progress-bar"></div>
                    </div>
                    <div id="kb-status" class="status"></div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Knowledge Base List</h3>
                    <table id="kb-list">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Knowledge base items will be added here -->
                            <tr>
                                <td colspan="3">No knowledge bases found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- FAQ Tab -->
                <div class="tab-content" id="faq-tab">
                    <div class="form-group">
                        <label for="faq-question">Question</label>
                        <input type="text" id="faq-question" placeholder="Enter a frequently asked question">
                    </div>
                    <div class="form-group">
                        <label for="faq-answer">Answer</label>
                        <textarea id="faq-answer" placeholder="Enter the answer to the question"></textarea>
                    </div>
                    <button id="add-faq">Add FAQ</button>
                    <div id="faq-single-status" class="status"></div>
                    
                    <div style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Or upload FAQ sheet (CSV/Excel with 'question' and 'answer' columns)</label>
                        </div>
                        <div class="file-input-container">
                            <div class="file-input-button">
                                Click to select a file (.csv, .xlsx)
                            </div>
                            <div class="file-name" id="faq-file-name">No file selected</div>
                            <input type="file" id="faq-file" accept=".csv,.xlsx">
                        </div>
                        <button id="upload-faq">Upload FAQ Sheet</button>
                        <div class="progress" id="faq-progress">
                            <div class="progress-bar" id="faq-progress-bar"></div>
                        </div>
                        <div id="faq-status" class="status"></div>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">FAQ List</h3>
                    <table id="faq-list">
                        <thead>
                            <tr>
                                <th>Question</th>
                                <th>Answer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- FAQ items will be added here -->
                            <tr>
                                <td colspan="3">No FAQs found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- System Prompt Tab -->
                <div class="tab-content" id="prompt-tab">
                    <div class="form-group">
                        <label for="system-prompt">System Prompt</label>
                        <textarea id="system-prompt" placeholder="Enter your custom system prompt" rows="10"></textarea>
                    </div>
                    <div class="form-group">
                        <p><strong>Available Variables:</strong></p>
                        <ul>
                            <li><code>{company_name}</code> - Your tenant name</li>
                            <li><code>{knowledge_base_info}</code> - Knowledge base context</li>
                            <li><code>{faq_info}</code> - All FAQs as a formatted string</li>
                        </ul>
                    </div>
                    <button id="save-prompt">Save System Prompt</button>
                    <div id="prompt-status" class="status"></div>
                </div>
            </div>
        </div>
        
        <!-- Right column with chat interface -->
        <div class="panel">
            <h2>Chatbot</h2>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot-message">
                        Hello! I'm your AI assistant. How can I help you today?
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <button id="send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const apiUrlInput = document.getElementById('api-url');
        const apiPortInput = document.getElementById('api-port');
        const apiKeyInput = document.getElementById('api-key');
        const saveConfigButton = document.getElementById('save-config');
        const configStatus = document.getElementById('config-status');
        
        const tenantNameInput = document.getElementById('tenant-name');
        const tenantDescriptionInput = document.getElementById('tenant-description');
        const createTenantButton = document.getElementById('create-tenant');
        const tenantStatus = document.getElementById('tenant-status');
        const currentTenantInfo = document.getElementById('current-tenant-info');
        
        const kbNameInput = document.getElementById('kb-name');
        const kbFileInput = document.getElementById('kb-file');
        const kbFileName = document.getElementById('kb-file-name');
        const uploadKbButton = document.getElementById('upload-kb');
        const kbProgress = document.getElementById('kb-progress');
        const kbProgressBar = document.getElementById('kb-progress-bar');
        const kbStatus = document.getElementById('kb-status');
        const kbList = document.getElementById('kb-list');
        
        const faqQuestionInput = document.getElementById('faq-question');
        const faqAnswerInput = document.getElementById('faq-answer');
        const addFaqButton = document.getElementById('add-faq');
        const faqSingleStatus = document.getElementById('faq-single-status');
        const faqFileInput = document.getElementById('faq-file');
        const faqFileName = document.getElementById('faq-file-name');
        const uploadFaqButton = document.getElementById('upload-faq');
        const faqProgress = document.getElementById('faq-progress');
        const faqProgressBar = document.getElementById('faq-progress-bar');
        const faqStatus = document.getElementById('faq-status');
        const faqList = document.getElementById('faq-list');
        
        const systemPromptInput = document.getElementById('system-prompt');
        const savePromptButton = document.getElementById('save-prompt');
        const promptStatus = document.getElementById('prompt-status');
        
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        
        // Tabs management
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        
        // File input management
        kbFileInput.addEventListener('change', () => {
            if (kbFileInput.files.length > 0) {
                kbFileName.textContent = kbFileInput.files[0].name;
            } else {
                kbFileName.textContent = 'No file selected';
            }
        });
        
        faqFileInput.addEventListener('change', () => {
            if (faqFileInput.files.length > 0) {
                faqFileName.textContent = faqFileInput.files[0].name;
            } else {
                faqFileName.textContent = 'No file selected';
            }
        });
        
        // Load configuration from localStorage
        let apiUrl = localStorage.getItem('chatbot_api_url') || 'http://127.0.0.1';
        let apiPort = localStorage.getItem('chatbot_api_port') || '8001';
        let apiKey = localStorage.getItem('chatbot_api_key') || '';
        
        // Set initial values
        apiUrlInput.value = apiUrl;
        apiPortInput.value = apiPort;
        apiKeyInput.value = apiKey;
        
        // User identifier for chat
        const userId = localStorage.getItem('chatbot_user_id') || 'user_' + Math.random().toString(36).substring(2, 9);
        localStorage.setItem('chatbot_user_id', userId);
        
        // Get full API URL
        function getApiUrl() {
            return `${apiUrl}:${apiPort}`;
        }
        
        // Show notification
        function showNotification(element, message, isSuccess = true) {
            element.textContent = message;
            element.className = isSuccess ? 'status success' : 'status error';
            
            setTimeout(() => {
                element.className = 'status';
            }, 3000);
        }
        
        // Add message to chat
        function addMessage(content, isUser) {
            const message = document.createElement('div');
            message.className = isUser ? 'message user-message' : 'message bot-message';
            message.textContent = content;
            chatMessages.appendChild(message);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Handle saving configuration
        saveConfigButton.addEventListener('click', () => {
            apiUrl = apiUrlInput.value.trim();
            apiPort = apiPortInput.value.trim();
            apiKey = apiKeyInput.value.trim();
            
            localStorage.setItem('chatbot_api_url', apiUrl);
            localStorage.setItem('chatbot_api_port', apiPort);
            localStorage.setItem('chatbot_api_key', apiKey);
            
            showNotification(configStatus, 'Configuration saved successfully!');
            
            // Refresh tenant info
            getTenantInfo();
            
            // Refresh knowledge base and FAQ lists
            refreshKnowledgeBases();
            refreshFaqs();
        });
        
        // Create a new tenant
        createTenantButton.addEventListener('click', async () => {
            const name = tenantNameInput.value.trim();
            const description = tenantDescriptionInput.value.trim();
            
            if (!name) {
                showNotification(tenantStatus, 'Please enter a tenant name', false);
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/tenants/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description
                    })
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                
                showNotification(tenantStatus, `Tenant created successfully! API Key: ${data.api_key}`);
                
                // Clear form
                tenantNameInput.value = '';
                tenantDescriptionInput.value = '';
                
                // Update API key
                apiKey = data.api_key;
                apiKeyInput.value = apiKey;
                localStorage.setItem('chatbot_api_key', apiKey);
                
                // Update tenant info
                getTenantInfo();
            } catch (error) {
                showNotification(tenantStatus, `Failed to create tenant: ${error.message}`, false);
            }
        });
        
        // Get tenant info
        async function getTenantInfo() {
            if (!apiKey) {
                currentTenantInfo.innerHTML = '<p>No tenant selected. Use API key to access your tenant.</p>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/tenants/me`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const tenant = await response.json();
                
                currentTenantInfo.innerHTML = `
                    <p><strong>Name:</strong> ${tenant.name}</p>
                    <p><strong>Description:</strong> ${tenant.description || 'N/A'}</p>
                    <p><strong>API Key:</strong> ${tenant.api_key}</p>
                `;
                
                // Load system prompt if available
                if (tenant.system_prompt) {
                    systemPromptInput.value = tenant.system_prompt;
                }
            } catch (error) {
                currentTenantInfo.innerHTML = `<p>Error loading tenant info: ${error.message}</p>`;
            }
        }
        
        // Upload knowledge base
        uploadKbButton.addEventListener('click', async () => {
            const name = kbNameInput.value.trim();
            const file = kbFileInput.files[0];
            
            if (!name) {
                showNotification(kbStatus, 'Please enter a document name', false);
                return;
            }
            
            if (!file) {
                showNotification(kbStatus, 'Please select a file', false);
                return;
            }
            
            if (!apiKey) {
                showNotification(kbStatus, 'Please set your API key first', false);
                return;
            }
            
            // Show progress
            kbProgress.style.display = 'block';
            kbProgressBar.style.width = '0%';
            
            // Create form data
            const formData = new FormData();
            formData.append('name', name);
            formData.append('file', file);
            
            try {
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress > 90) clearInterval(progressInterval);
                    kbProgressBar.style.width = `${progress}%`;
                }, 300);
                
                // Upload file
                const response = await fetch(`${getApiUrl()}/knowledge-base/upload`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey
                    },
                    body: formData
                });
                
                clearInterval(progressInterval);
                kbProgressBar.style.width = '100%';
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                
                showNotification(kbStatus, 'Knowledge base uploaded successfully!');
                
                // Clear form
                kbNameInput.value = '';
                kbFileInput.value = '';
                kbFileName.textContent = 'No file selected';
                
                // Refresh knowledge base list
                refreshKnowledgeBases();
                
            } catch (error) {
                kbProgressBar.style.width = '0%';
                showNotification(kbStatus, `Failed to upload knowledge base: ${error.message}`, false);
            } finally {
                setTimeout(() => {
                    kbProgress.style.display = 'none';
                }, 1000);
            }
        });
        
        // Refresh knowledge base list
        async function refreshKnowledgeBases() {
            if (!apiKey) {
                kbList.querySelector('tbody').innerHTML = '<tr><td colspan="3">Please set your API key first</td></tr>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/knowledge-base/`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                const tbody = kbList.querySelector('tbody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">No knowledge bases found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                data.forEach(kb => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${kb.name}</td>
                        <td>${kb.document_type}</td>
                        <td>
                            <button class="delete-kb" data-id="${kb.id}">Delete</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-kb').forEach(button => {
                    button.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this knowledge base?')) {
                            const kbId = button.dataset.id;
                            
                            try {
                                const response = await fetch(`${getApiUrl()}/knowledge-base/${kbId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'X-API-Key': apiKey
                                    }
                                });
                                
                                if (!response.ok) {
                                    throw new Error(await response.text());
                                }
                                
                                showNotification(kbStatus, 'Knowledge base deleted successfully!');
                                
                                // Refresh list
                                refreshKnowledgeBases();
                                
                            } catch (error) {
                                showNotification(kbStatus, `Failed to delete knowledge base: ${error.message}`, false);
                            }
                        }
                    });
                });
                
            } catch (error) {
                kbList.querySelector('tbody').innerHTML = `<tr><td colspan="3">Error loading knowledge bases: ${error.message}</td></tr>`;
            }
        }
        
        // Add single FAQ
        addFaqButton.addEventListener('click', async () => {
            const question = faqQuestionInput.value.trim();
            const answer = faqAnswerInput.value.trim();
            
            if (!question || !answer) {
                showNotification(faqSingleStatus, 'Please enter both question and answer', false);
                return;
            }
            
            if (!apiKey) {
                showNotification(faqSingleStatus, 'Please set your API key first', false);
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/knowledge-base/faqs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        question: question,
                        answer: answer
                    })
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                await response.json();
                
                showNotification(faqSingleStatus, 'FAQ added successfully!');
                
                // Clear form
                faqQuestionInput.value = '';
                faqAnswerInput.value = '';
                
                // Refresh FAQ list
                refreshFaqs();
                
            } catch (error) {
                showNotification(faqSingleStatus, `Failed to add FAQ: ${error.message}`, false);
            }
        });
        
        // Upload FAQ sheet
        uploadFaqButton.addEventListener('click', async () => {
            const file = faqFileInput.files[0];
            
            if (!file) {
                showNotification(faqStatus, 'Please select a file', false);
                return;
            }
            
            if (!apiKey) {
                showNotification(faqStatus, 'Please set your API key first', false);
                return;
            }
            
            // Show progress
            faqProgress.style.display = 'block';
            faqProgressBar.style.width = '0%';
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress > 90) clearInterval(progressInterval);
                    faqProgressBar.style.width = `${progress}%`;
                }, 300);
                
                // Upload file
                const response = await fetch(`${getApiUrl()}/knowledge-base/faqs/upload`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey
                    },
                    body: formData
                });
                
                clearInterval(progressInterval);
                faqProgressBar.style.width = '100%';
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                
                showNotification(faqStatus, `FAQ sheet uploaded successfully! Added ${data.length} FAQ items.`);
                
                // Clear form
                faqFileInput.value = '';
                faqFileName.textContent = 'No file selected';
                
                // Refresh FAQ list
                refreshFaqs();
                
            } catch (error) {
                faqProgressBar.style.width = '0%';
                showNotification(faqStatus, `Failed to upload FAQ sheet: ${error.message}`, false);
            } finally {
                setTimeout(() => {
                    faqProgress.style.display = 'none';
                }, 1000);
            }
        });
        
        // Refresh FAQ list
        async function refreshFaqs() {
            if (!apiKey) {
                faqList.querySelector('tbody').innerHTML = '<tr><td colspan="3">Please set your API key first</td></tr>';
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/knowledge-base/faqs`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                const tbody = faqList.querySelector('tbody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">No FAQs found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                data.forEach(faq => {
                    const row = document.createElement('tr');
                    
                    // Truncate long answers for display
                    const shortAnswer = faq.answer.length > 50 ? faq.answer.substring(0, 50) + '...' : faq.answer;
                    
                    row.innerHTML = `
                        <td>${faq.question}</td>
                        <td>${shortAnswer}</td>
                        <td>
                            <button class="delete-faq" data-id="${faq.id}">Delete</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-faq').forEach(button => {
                    button.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this FAQ?')) {
                            const faqId = button.dataset.id;
                            
                            try {
                                const response = await fetch(`${getApiUrl()}/knowledge-base/faqs/${faqId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'X-API-Key': apiKey
                                    }
                                });
                                
                                if (!response.ok) {
                                    throw new Error(await response.text());
                                }
                                
                                showNotification(faqStatus, 'FAQ deleted successfully!');
                                
                                // Refresh list
                                refreshFaqs();
                                
                            } catch (error) {
                                showNotification(faqStatus, `Failed to delete FAQ: ${error.message}`, false);
                            }
                        }
                    });
                });
                
            } catch (error) {
                faqList.querySelector('tbody').innerHTML = `<tr><td colspan="3">Error loading FAQs: ${error.message}</td></tr>`;
            }
        }
        
        // Save system prompt
        savePromptButton.addEventListener('click', async () => {
            const prompt = systemPromptInput.value.trim();
            
            if (!prompt) {
                showNotification(promptStatus, 'Please enter a system prompt', false);
                return;
            }
            
            if (!apiKey) {
                showNotification(promptStatus, 'Please set your API key first', false);
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/tenants/prompt`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        system_prompt: prompt
                    })
                });
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                showNotification(promptStatus, 'System prompt saved successfully!');
                
            } catch (error) {
                showNotification(promptStatus, `Failed to save system prompt: ${error.message}`, false);
            }
        });
        
        // Send message to the chatbot
        async function sendMessage(message) {
            if (!apiKey) {
                addMessage('Please set your API key first', false);
                return;
            }
            
            // Show typing indicator
            typingIndicator.style.display = 'flex';
            
            try {
                const response = await fetch(`${getApiUrl()}/chatbot/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({
                        message: message,
                        user_identifier: userId
                    })
                });
                
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const data = await response.json();
                
                // Add bot response to chat
                addMessage(data.response, false);
                
            } catch (error) {
                typingIndicator.style.display = 'none';
                addMessage(`Error: ${error.message}`, false);
            }
        }
        
        // Chat input event listeners
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                addMessage(message, true);
                messageInput.value = '';
                sendMessage(message);
            }
        });
        
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                const message = messageInput.value.trim();
                if (message) {
                    addMessage(message, true);
                    messageInput.value = '';
                    sendMessage(message);
                }
            }
        });
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            getTenantInfo();
            refreshKnowledgeBases();
            refreshFaqs();
        });
    </script>
</body>
</html>